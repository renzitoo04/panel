<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>N√∫meros de WhatsApp - Rotaci√≥n</title>
    <link rel="stylesheet" href="/style.css">
</head>
<body>
    <!-- SIDEBAR LATERAL PLEGABLE -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <h3>Navegaci√≥n</h3>
            <button class="sidebar-toggle" onclick="toggleSidebar()">
                <span class="toggle-icon">‚óÄ</span>
            </button>
        </div>

        <div class="sidebar-menu">
            <a href="/" class="menu-item">
                <span class="menu-icon">üìä</span>
                <span class="menu-text">Dashboard</span>
            </a>
            <a href="/campaigns" class="menu-item">
                <span class="menu-icon">üí∞</span>
                <span class="menu-text">Campa√±as</span>
            </a>
            <a href="/numeros" class="menu-item active">
                <span class="menu-icon">üì±</span>
                <span class="menu-text">N√∫meros</span>
            </a>
            <a href="/settings" class="menu-item">
                <span class="menu-icon">‚öôÔ∏è</span>
                <span class="menu-text">Configuraci√≥n</span>
            </a>
        </div>
    </div>

    <!-- BOT√ìN FLOTANTE PARA ABRIR SIDEBAR (cuando est√° cerrado) -->
    <button class="sidebar-floating-btn" id="sidebarFloatingBtn" onclick="toggleSidebar()">
        <span>‚ñ∂</span>
    </button>

    <div class="main-content" id="mainContent">
        <div class="container">
        <header class="header">
            <div class="header-content">
                <div class="header-title">
                    <h1>üì± N√∫meros de WhatsApp</h1>
                    <p class="subtitle">Gestiona la rotaci√≥n de n√∫meros para distribuir leads</p>
                </div>
                <div class="landing-selector">
                    <label for="landingSelect">Landing Page:</label>
                    <select id="landingSelect" class="landing-select" onchange="switchLanding(this.value)">
                        <option value="default">Cargando...</option>
                    </select>
                </div>
            </div>
        </header>

        <!-- INFO DE ROTACI√ìN -->
        <section class="info-section">
            <div class="info-card">
                <h3>‚ÑπÔ∏è ¬øC√≥mo funciona la rotaci√≥n?</h3>
                <p>Los n√∫meros rotan autom√°ticamente con cada click en el bot√≥n de WhatsApp:</p>
                <ul>
                    <li><strong>Round-robin:</strong> Los leads se distribuyen equitativamente entre todos los n√∫meros</li>
                    <li><strong>Hasta 10 n√∫meros:</strong> Puedes agregar hasta 10 n√∫meros por landing</li>
                    <li><strong>Autom√°tico:</strong> No necesitas hacer nada, la rotaci√≥n es transparente</li>
                    <li><strong>Por landing:</strong> Cada landing tiene su propia rotaci√≥n independiente</li>
                </ul>
            </div>
        </section>

        <!-- N√öMERO POR DEFECTO -->
        <% if (defaultNumber) { %>
        <section class="default-number-section">
            <div class="section-header">
                <h2>üì± N√∫mero Actual (Por Defecto)</h2>
            </div>
            <div class="default-number-card">
                <div class="number-header">
                    <div class="number-info">
                        <span class="number-badge">üè†</span>
                        <h3 class="number-label">N√∫mero Principal</h3>
                    </div>
                    <div class="number-actions">
                        <button onclick="openEditDefaultNumberModal()" class="btn-icon" title="Editar n√∫mero principal" style="background: #3b82f6; color: white; padding: 8px 16px; border-radius: 6px; border: none; cursor: pointer;">
                            ‚úèÔ∏è Editar
                        </button>
                        <div class="status-badge status-active">
                            ‚úÖ Activo
                        </div>
                    </div>
                </div>
                <div class="number-content">
                    <div class="number-display">
                        <span class="number-value" id="defaultNumberDisplay"><%= defaultNumber %></span>
                    </div>
                    <div class="default-info">
                        <p><strong>Este es tu n√∫mero por defecto.</strong></p>
                        <% if (numbers.length === 0) { %>
                        <p>Se usa autom√°ticamente cuando no hay n√∫meros de rotaci√≥n configurados.</p>
                        <% } else { %>
                        <p>Los n√∫meros de rotaci√≥n (abajo) se usan en vez de este cuando est√°n configurados.</p>
                        <% } %>
                        <p style="margin-top: 10px; color: #f59e0b; font-size: 14px;">üí° <strong>Tip:</strong> Ed√≠talo r√°pidamente en caso de ca√≠das o bloqueos del n√∫mero principal.</p>
                    </div>
                </div>
            </div>
        </section>
        <% } %>

        <!-- LISTA DE N√öMEROS DE ROTACI√ìN -->
        <section class="numbers-section">
            <div class="section-header">
                <h2>üîÑ N√∫meros de Rotaci√≥n (<span id="numberCount"><%= numbers.length %></span>/10)</h2>
                <button onclick="openAddNumberModal()" class="btn btn-primary" id="addNumberBtn">
                    + Agregar N√∫mero
                </button>
            </div>

            <div class="numbers-grid" id="numbersGrid">
                <% if (numbers.length === 0) { %>
                    <div class="empty-state">
                        <p>No hay n√∫meros de rotaci√≥n configurados</p>
                        <p class="subtitle">Agrega n√∫meros aqu√≠ para distribuir leads entre varios WhatsApp</p>
                        <button onclick="openAddNumberModal()" class="btn btn-primary">+ Agregar N√∫mero</button>
                    </div>
                <% } else {
                    numbers.forEach((number, index) => { %>
                    <div class="number-card" data-id="<%= number.id %>">
                        <div class="number-header">
                            <div class="number-info">
                                <span class="number-badge">#<%= index + 1 %></span>
                                <h3 class="number-label"><%= number.label || 'Sin nombre' %></h3>
                            </div>
                            <div class="number-actions">
                                <button onclick="editNumber('<%= number.id %>', '<%= number.number %>', '<%= number.label %>')" class="btn-icon" title="Editar">
                                    ‚úèÔ∏è
                                </button>
                                <button onclick="deleteNumber('<%= number.id %>')" class="btn-icon" title="Eliminar">
                                    üóëÔ∏è
                                </button>
                            </div>
                        </div>
                        <div class="number-content">
                            <div class="number-display">
                                <span class="number-value"><%= number.number %></span>
                            </div>
                            <div class="number-meta">
                                <span class="meta-label">Agregado:</span>
                                <span class="meta-value"><%= new Date(number.createdAt).toLocaleDateString('es-AR') %></span>
                            </div>
                        </div>
                    </div>
                <% }); } %>
            </div>
        </section>

        <!-- MODAL AGREGAR N√öMERO -->
        <div id="addNumberModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>‚ûï Agregar N√∫mero de WhatsApp</h3>
                    <span class="close" onclick="closeAddNumberModal()">&times;</span>
                </div>
                <form id="addNumberForm" class="modal-form">
                    <div class="form-group">
                        <label for="numberLabel">Nombre/Etiqueta:</label>
                        <input type="text" id="numberLabel" name="label" placeholder="Ej: Vendedor 1, Soporte, etc.">
                        <small>Opcional - Para identificar el n√∫mero f√°cilmente</small>
                    </div>
                    <div class="form-group">
                        <label for="numberValue">N√∫mero de WhatsApp:</label>
                        <input type="text" id="numberValue" name="number" required placeholder="Ej: 5491112345678">
                        <small>Formato: C√≥digo de pa√≠s + √Årea + N√∫mero (sin espacios ni s√≠mbolos)</small>
                    </div>
                    <div class="form-actions">
                        <button type="button" onclick="closeAddNumberModal()" class="btn btn-secondary">Cancelar</button>
                        <button type="submit" class="btn btn-primary">Agregar</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- MODAL EDITAR N√öMERO -->
        <div id="editNumberModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>‚úèÔ∏è Editar N√∫mero de WhatsApp</h3>
                    <span class="close" onclick="closeEditNumberModal()">&times;</span>
                </div>
                <form id="editNumberForm" class="modal-form">
                    <input type="hidden" id="editNumberId" name="id">
                    <div class="form-group">
                        <label for="editNumberLabel">Nombre/Etiqueta:</label>
                        <input type="text" id="editNumberLabel" name="label" placeholder="Ej: Vendedor 1, Soporte, etc.">
                        <small>Opcional - Para identificar el n√∫mero f√°cilmente</small>
                    </div>
                    <div class="form-group">
                        <label for="editNumberValue">N√∫mero de WhatsApp:</label>
                        <input type="text" id="editNumberValue" name="number" required placeholder="Ej: 5491112345678">
                        <small>Formato: C√≥digo de pa√≠s + √Årea + N√∫mero (sin espacios ni s√≠mbolos)</small>
                    </div>
                    <div class="form-actions">
                        <button type="button" onclick="closeEditNumberModal()" class="btn btn-secondary">Cancelar</button>
                        <button type="submit" class="btn btn-primary">Guardar</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- MODAL EDITAR N√öMERO POR DEFECTO -->
        <div id="editDefaultNumberModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>üè† Editar N√∫mero Principal</h3>
                    <span class="close" onclick="closeEditDefaultNumberModal()">&times;</span>
                </div>
                <form id="editDefaultNumberForm" class="modal-form">
                    <div class="alert-info" style="background: #fef3c7; padding: 12px; border-radius: 6px; margin-bottom: 16px;">
                        <p style="margin: 0; color: #92400e;">‚ö†Ô∏è <strong>Importante:</strong> Este n√∫mero se usa en todas las landings que no tienen rotaci√≥n configurada.</p>
                    </div>
                    <div class="form-group">
                        <label for="defaultNumberValue">N√∫mero Principal de WhatsApp:</label>
                        <input type="text" id="defaultNumberValue" name="number" value="<%= defaultNumber %>" required placeholder="Ej: 5491112345678">
                        <small>Formato: C√≥digo de pa√≠s + √Årea + N√∫mero (sin espacios ni s√≠mbolos)</small>
                    </div>
                    <div class="form-actions">
                        <button type="button" onclick="closeEditDefaultNumberModal()" class="btn btn-secondary">Cancelar</button>
                        <button type="submit" class="btn btn-primary">üíæ Guardar Cambios</button>
                    </div>
                </form>
            </div>
        </div>

        </div>
    </div>

    <script>
        // Obtener el landing actual del servidor
        const currentLandingId = '<%= currentLandingId %>';

        // Load landings dynamically
        async function loadLandingSelector() {
            try {
                const response = await fetch('/api/landings');
                const data = await response.json();

                if (data.success && data.landings) {
                    const select = document.getElementById('landingSelect');
                    select.innerHTML = '';

                    data.landings.forEach(landing => {
                        const option = document.createElement('option');
                        option.value = landing.id;
                        option.textContent = landing.name;
                        if (landing.id === currentLandingId) {
                            option.selected = true;
                        }
                        select.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error loading landings:', error);
            }
        }

        // Call on page load
        loadLandingSelector();

        // Funci√≥n para cambiar de landing
        function switchLanding(landingId) {
            fetch('/api/switch-landing', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ landingId })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    window.location.reload();
                } else {
                    alert('Error al cambiar de landing');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error al cambiar de landing');
            });
        }

        // FUNCIONES PARA SIDEBAR
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const mainContent = document.getElementById('mainContent');
            const floatingBtn = document.getElementById('sidebarFloatingBtn');

            sidebar.classList.toggle('collapsed');
            mainContent.classList.toggle('expanded');

            if (sidebar.classList.contains('collapsed')) {
                floatingBtn.style.display = 'flex';
            } else {
                floatingBtn.style.display = 'none';
            }
        }

        // FUNCIONES PARA MODAL AGREGAR
        function openAddNumberModal() {
            const numberCount = parseInt(document.getElementById('numberCount').textContent);
            if (numberCount >= 10) {
                alert('Has alcanzado el l√≠mite de 10 n√∫meros de WhatsApp');
                return;
            }
            document.getElementById('addNumberModal').style.display = 'flex';
        }

        function closeAddNumberModal() {
            document.getElementById('addNumberModal').style.display = 'none';
            document.getElementById('addNumberForm').reset();
        }

        // FUNCIONES PARA MODAL EDITAR
        function openEditNumberModal() {
            document.getElementById('editNumberModal').style.display = 'flex';
        }

        function closeEditNumberModal() {
            document.getElementById('editNumberModal').style.display = 'none';
            document.getElementById('editNumberForm').reset();
        }

        function editNumber(id, number, label) {
            document.getElementById('editNumberId').value = id;
            document.getElementById('editNumberValue').value = number;
            document.getElementById('editNumberLabel').value = label;
            openEditNumberModal();
        }

        // FUNCIONES PARA MODAL EDITAR N√öMERO POR DEFECTO
        function openEditDefaultNumberModal() {
            document.getElementById('editDefaultNumberModal').style.display = 'flex';
        }

        function closeEditDefaultNumberModal() {
            document.getElementById('editDefaultNumberModal').style.display = 'none';
            document.getElementById('editDefaultNumberForm').reset();
        }

        // Cerrar modales al hacer click fuera
        window.onclick = function(event) {
            const addModal = document.getElementById('addNumberModal');
            const editModal = document.getElementById('editNumberModal');
            const editDefaultModal = document.getElementById('editDefaultNumberModal');

            if (event.target === addModal) {
                closeAddNumberModal();
            }
            if (event.target === editModal) {
                closeEditNumberModal();
            }
            if (event.target === editDefaultModal) {
                closeEditDefaultNumberModal();
            }
        };

        // Manejar env√≠o de formulario AGREGAR
        document.getElementById('addNumberForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const formData = new FormData(e.target);
            const number = formData.get('number').trim();
            const label = formData.get('label').trim();

            try {
                const response = await fetch('/api/whatsapp-numbers', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ number, label })
                });

                const data = await response.json();

                if (data.success) {
                    alert('N√∫mero agregado correctamente!');
                    closeAddNumberModal();
                    location.reload();
                } else {
                    alert('Error: ' + data.error);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error al agregar el n√∫mero');
            }
        });

        // Manejar env√≠o de formulario EDITAR
        document.getElementById('editNumberForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const formData = new FormData(e.target);
            const id = formData.get('id');
            const number = formData.get('number').trim();
            const label = formData.get('label').trim();

            try {
                const response = await fetch(`/api/whatsapp-numbers/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ number, label })
                });

                const data = await response.json();

                if (data.success) {
                    alert('N√∫mero actualizado correctamente!');
                    closeEditNumberModal();
                    location.reload();
                } else {
                    alert('Error: ' + data.error);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error al actualizar el n√∫mero');
            }
        });

        // Manejar env√≠o de formulario EDITAR N√öMERO POR DEFECTO
        document.getElementById('editDefaultNumberForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const formData = new FormData(e.target);
            const number = formData.get('number').trim();

            if (!number) {
                alert('Por favor ingresa un n√∫mero v√°lido');
                return;
            }

            try {
                const response = await fetch('/api/default-whatsapp', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ number })
                });

                const data = await response.json();

                if (data.success) {
                    alert('‚úÖ N√∫mero principal actualizado correctamente!');
                    closeEditDefaultNumberModal();
                    // Actualizar el display sin recargar
                    document.getElementById('defaultNumberDisplay').textContent = number;
                } else {
                    alert('Error: ' + data.error);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error al actualizar el n√∫mero principal');
            }
        });

        // Funci√≥n para eliminar n√∫mero
        async function deleteNumber(id) {
            if (!confirm('¬øEst√°s seguro de eliminar este n√∫mero?')) {
                return;
            }

            try {
                const response = await fetch(`/api/whatsapp-numbers/${id}`, {
                    method: 'DELETE'
                });

                const data = await response.json();

                if (data.success) {
                    alert('N√∫mero eliminado correctamente!');
                    location.reload();
                } else {
                    alert('Error: ' + data.error);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error al eliminar el n√∫mero');
            }
        }

        // Actualizar bot√≥n de agregar seg√∫n cantidad
        function updateAddButton() {
            const numberCount = parseInt(document.getElementById('numberCount').textContent);
            const addBtn = document.getElementById('addNumberBtn');

            if (numberCount >= 10) {
                addBtn.disabled = true;
                addBtn.textContent = 'L√≠mite Alcanzado (10/10)';
                addBtn.style.opacity = '0.5';
            }
        }

        updateAddButton();
    </script>
</body>
</html>
