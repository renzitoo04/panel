<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Finanzas - Panel CRM</title>
    <link rel="stylesheet" href="/style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
</head>
<body>
    <!-- SIDEBAR LATERAL PLEGABLE -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <h3>Navegaci√≥n</h3>
            <button class="sidebar-toggle" onclick="toggleSidebar()">
                <span class="toggle-icon">‚óÄ</span>
            </button>
        </div>

        <div class="sidebar-menu">
            <a href="/" class="menu-item">
                <span class="menu-icon">üìä</span>
                <span class="menu-text">Dashboard</span>
            </a>
            <a href="/campaigns" class="menu-item">
                <span class="menu-icon">üí∞</span>
                <span class="menu-text">Campa√±as</span>
            </a>
            <a href="/finanzas" class="menu-item active">
                <span class="menu-icon">üíµ</span>
                <span class="menu-text">Finanzas</span>
            </a>
            <a href="/numeros" class="menu-item">
                <span class="menu-icon">üì±</span>
                <span class="menu-text">N√∫meros</span>
            </a>
            <a href="/settings" class="menu-item">
                <span class="menu-icon">‚öôÔ∏è</span>
                <span class="menu-text">Configuraci√≥n</span>
            </a>
        </div>
    </div>

    <!-- BOT√ìN FLOTANTE PARA ABRIR SIDEBAR (cuando est√° cerrado) -->
    <button class="sidebar-floating-btn" id="sidebarFloatingBtn" onclick="toggleSidebar()">
        <span>‚ñ∂</span>
    </button>

    <div class="main-content" id="mainContent">
        <div class="container">
        <header class="header">
            <div class="header-content">
                <div class="header-title">
                    <h1>üíµ Centro Financiero</h1>
                    <p class="subtitle">An√°lisis completo de rentabilidad y proyecciones</p>
                </div>
            </div>
        </header>

        <!-- FILTROS DE FECHA -->
        <section style="background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 16px; padding: 20px; margin-top: 20px;">
            <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;">
                <div>
                    <h3 style="margin: 0 0 5px 0; font-size: 16px;">üìÖ Filtrar por Per√≠odo</h3>
                    <p style="margin: 0; font-size: 13px; opacity: 0.7;">Todos los datos se ajustar√°n al per√≠odo seleccionado</p>
                </div>

                <div style="display: flex; gap: 10px; flex-wrap: wrap; align-items: center;">
                    <button onclick="setDateFilter('today')" id="btn-today" class="filter-btn">Hoy</button>
                    <button onclick="setDateFilter('week')" id="btn-week" class="filter-btn">Esta Semana</button>
                    <button onclick="setDateFilter('month')" id="btn-month" class="filter-btn active">Este Mes</button>
                    <button onclick="setDateFilter('all')" id="btn-all" class="filter-btn">Todo</button>

                    <div style="display: flex; gap: 8px; align-items: center; margin-left: 10px;">
                        <label style="font-size: 13px; opacity: 0.8;">Desde:</label>
                        <input type="date" id="date-from" style="padding: 6px 10px; border-radius: 6px; border: 1px solid rgba(255,255,255,0.2); background: rgba(255,255,255,0.1); color: white;">

                        <label style="font-size: 13px; opacity: 0.8;">Hasta:</label>
                        <input type="date" id="date-to" style="padding: 6px 10px; border-radius: 6px; border: 1px solid rgba(255,255,255,0.2); background: rgba(255,255,255,0.1); color: white;">

                        <button onclick="applyCustomDateFilter()" style="padding: 6px 16px; border-radius: 6px; background: #3b82f6; color: white; border: none; cursor: pointer; font-weight: 600;">Aplicar</button>
                    </div>
                </div>
            </div>
        </section>

        <!-- FEEDBACK DE FILTROS -->
        <% if (hasFilter) { %>
        <div style="background: linear-gradient(135deg, rgba(59, 130, 246, 0.15), rgba(37, 99, 235, 0.05)); border: 1px solid rgba(59, 130, 246, 0.3); border-radius: 12px; padding: 15px 20px; margin-top: 15px; display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 10px;">
            <div style="display: flex; align-items: center; gap: 12px;">
                <span style="font-size: 24px;">üìä</span>
                <div>
                    <div style="font-size: 14px; font-weight: 600; color: #3b82f6;">Filtro aplicado</div>
                    <div style="font-size: 13px; opacity: 0.8; margin-top: 2px;">
                        Mostrando <strong><%= filteredCount %></strong> de <%= totalCount %> eventos totales
                        <% if (dateFrom && dateTo) { %>
                            (desde <%= new Date(dateFrom).toLocaleDateString('es-AR') %> hasta <%= new Date(dateTo).toLocaleDateString('es-AR') %>)
                        <% } %>
                    </div>
                </div>
            </div>
            <button onclick="window.location.href='/finanzas'" style="padding: 8px 16px; border-radius: 8px; background: rgba(239, 68, 68, 0.2); color: #ef4444; border: 1px solid rgba(239, 68, 68, 0.3); cursor: pointer; font-weight: 600; font-size: 13px; transition: all 0.3s;">
                ‚úï Limpiar filtro
            </button>
        </div>
        <% } %>

        <!-- COTIZACI√ìN DEL D√ìLAR (SOLO ARS Y USD) -->
        <section class="conversion-metrics" style="margin-top: 20px;">
            <h2 style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">
                üí± Cotizaci√≥n del D√≥lar (ARS ‚Üî USD)
            </h2>

            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 15px; margin-top: 20px;">
                <% if (dolar && dolar.success) { %>
                    <!-- D√≥lar Blue (Principal) -->
                    <div style="background: linear-gradient(135deg, rgba(16, 185, 129, 0.15), rgba(5, 150, 105, 0.05)); border: 2px solid rgba(16, 185, 129, 0.4); border-radius: 12px; padding: 20px; text-align: center; box-shadow: 0 0 20px rgba(16, 185, 129, 0.3);">
                        <div style="font-size: 13px; opacity: 0.7; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px;">üíµ Blue (Usado en el panel)</div>
                        <div style="font-size: 36px; font-weight: bold; color: #10b981; margin: 10px 0;">$<%= dolar.dolares.blue.venta.toFixed(2) %></div>
                        <div style="font-size: 13px; opacity: 0.7; margin-top: 8px;">
                            <span style="color: #10b981;">Venta: $<%= dolar.dolares.blue.venta.toFixed(2) %></span> ‚Ä¢
                            <span style="color: #059669;">Compra: $<%= dolar.dolares.blue.compra.toFixed(2) %></span>
                        </div>
                    </div>

                    <!-- D√≥lar Oficial (Referencia) -->
                    <div style="background: linear-gradient(135deg, rgba(59, 130, 246, 0.15), rgba(37, 99, 235, 0.05)); border: 2px solid rgba(59, 130, 246, 0.4); border-radius: 12px; padding: 20px; text-align: center;">
                        <div style="font-size: 13px; opacity: 0.7; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px;">üèõÔ∏è Oficial (Referencia)</div>
                        <div style="font-size: 36px; font-weight: bold; color: #3b82f6; margin: 10px 0;">$<%= dolar.dolares.oficial.venta.toFixed(2) %></div>
                        <div style="font-size: 13px; opacity: 0.7; margin-top: 8px;">
                            <span style="color: #3b82f6;">Venta: $<%= dolar.dolares.oficial.venta.toFixed(2) %></span> ‚Ä¢
                            <span style="color: #2563eb;">Compra: $<%= dolar.dolares.oficial.compra.toFixed(2) %></span>
                        </div>
                    </div>
                <% } else { %>
                    <div style="grid-column: 1 / -1; text-align: center; padding: 20px; color: #ef4444;">
                        ‚ö†Ô∏è No se pudo obtener la cotizaci√≥n del d√≥lar
                    </div>
                <% } %>
            </div>

            <div style="margin-top: 15px; text-align: center; font-size: 12px; opacity: 0.6;">
                Actualizado: <%= new Date().toLocaleString('es-AR') %> | Fuente: DolarAPI.com
            </div>
        </section>

        <!-- RESUMEN FINANCIERO PRINCIPAL -->
        <section class="conversion-metrics" style="margin-top: 30px;">
            <h2 style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">
                üìä Resumen Financiero
            </h2>

            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-top: 20px;">
                <!-- Total Ingresos -->
                <div style="background: linear-gradient(135deg, rgba(16, 185, 129, 0.15), rgba(5, 150, 105, 0.05)); border: 2px solid rgba(16, 185, 129, 0.3); border-radius: 16px; padding: 25px; position: relative; overflow: hidden;">
                    <div style="position: absolute; top: 10px; right: 10px; font-size: 50px; opacity: 0.1;">üí∞</div>
                    <div style="font-size: 14px; opacity: 0.8; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 10px;">Ingresos Totales</div>
                    <div style="font-size: 36px; font-weight: bold; color: #10b981; margin-bottom: 8px;">
                        $<%= financial.summary.totalRevenue.toLocaleString('es-AR', {minimumFractionDigits: 2}) %>
                    </div>
                    <div style="font-size: 16px; opacity: 0.7;">
                        USD $<%= financial.summary.totalRevenueUSD.toLocaleString('es-AR', {minimumFractionDigits: 2}) %>
                    </div>
                    <div style="margin-top: 10px; font-size: 13px; opacity: 0.6;">
                        üì¶ <%= financial.summary.totalPurchases %> ventas realizadas
                    </div>
                </div>

                <!-- Total Gastos -->
                <div style="background: linear-gradient(135deg, rgba(239, 68, 68, 0.15), rgba(220, 38, 38, 0.05)); border: 2px solid rgba(239, 68, 68, 0.3); border-radius: 16px; padding: 25px; position: relative; overflow: hidden;">
                    <div style="position: absolute; top: 10px; right: 10px; font-size: 50px; opacity: 0.1;">üí∏</div>
                    <div style="font-size: 14px; opacity: 0.8; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 10px;">Gastos en Publicidad</div>
                    <div style="font-size: 36px; font-weight: bold; color: #ef4444; margin-bottom: 8px;">
                        $<%= financial.summary.totalSpend.toLocaleString('es-AR', {minimumFractionDigits: 2}) %>
                    </div>
                    <div style="font-size: 16px; opacity: 0.7;">
                        USD $<%= financial.summary.totalSpendUSD.toLocaleString('es-AR', {minimumFractionDigits: 2}) %>
                    </div>
                    <div style="margin-top: 10px; font-size: 13px; opacity: 0.6;">
                        üë• <%= financial.summary.totalClicks %> clicks generados
                    </div>
                </div>

                <!-- Ganancia Neta -->
                <div style="background: linear-gradient(135deg, <%= financial.summary.totalProfit >= 0 ? 'rgba(59, 130, 246, 0.15), rgba(37, 99, 235, 0.05)' : 'rgba(239, 68, 68, 0.15), rgba(220, 38, 38, 0.05)' %>); border: 2px solid <%= financial.summary.totalProfit >= 0 ? 'rgba(59, 130, 246, 0.3)' : 'rgba(239, 68, 68, 0.3)' %>; border-radius: 16px; padding: 25px; position: relative; overflow: hidden; box-shadow: 0 8px 24px <%= financial.summary.totalProfit >= 0 ? 'rgba(59, 130, 246, 0.2)' : 'rgba(239, 68, 68, 0.2)' %>;">
                    <div style="position: absolute; top: 10px; right: 10px; font-size: 50px; opacity: 0.1;"><%= financial.summary.totalProfit >= 0 ? 'üìà' : 'üìâ' %></div>
                    <div style="font-size: 14px; opacity: 0.8; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 10px;">Ganancia Neta</div>
                    <div style="font-size: 36px; font-weight: bold; color: <%= financial.summary.totalProfit >= 0 ? '#3b82f6' : '#ef4444' %>; margin-bottom: 8px;">
                        <%= financial.summary.totalProfit >= 0 ? '+' : '' %>$<%= financial.summary.totalProfit.toLocaleString('es-AR', {minimumFractionDigits: 2}) %>
                    </div>
                    <div style="font-size: 16px; opacity: 0.7;">
                        USD $<%= financial.summary.totalProfitUSD.toLocaleString('es-AR', {minimumFractionDigits: 2}) %>
                    </div>
                    <div style="margin-top: 10px; font-size: 13px; opacity: 0.6;">
                        üìä Margen: <%= financial.summary.profitMargin.toFixed(2) %>%
                    </div>
                </div>
            </div>
        </section>

        <!-- M√âTRICAS DE RENTABILIDAD -->
        <section class="conversion-metrics" style="margin-top: 30px;">
            <h2>üìà M√©tricas de Rentabilidad</h2>

            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 15px; margin-top: 20px;">
                <!-- ROI -->
                <div style="background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; padding: 20px; text-align: center;">
                    <div style="font-size: 48px; margin-bottom: 10px;">üéØ</div>
                    <div style="font-size: 32px; font-weight: bold; color: <%= financial.summary.roi >= 0 ? '#10b981' : '#ef4444' %>;">
                        <%= financial.summary.roi >= 0 ? '+' : '' %><%= financial.summary.roi.toFixed(2) %>%
                    </div>
                    <div style="font-size: 14px; opacity: 0.7; margin-top: 8px;">ROI (Return on Investment)</div>
                </div>

                <!-- ROAS Global -->
                <div style="background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; padding: 20px; text-align: center;">
                    <div style="font-size: 48px; margin-bottom: 10px;">üíé</div>
                    <div style="font-size: 32px; font-weight: bold; color: #3b82f6;">
                        <%= financial.rentability.roasGlobal.toFixed(2) %>x
                    </div>
                    <div style="font-size: 14px; opacity: 0.7; margin-top: 8px;">ROAS Global</div>
                </div>

                <!-- Ticket Promedio -->
                <div style="background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; padding: 20px; text-align: center;">
                    <div style="font-size: 48px; margin-bottom: 10px;">üè∑Ô∏è</div>
                    <div style="font-size: 32px; font-weight: bold; color: #f59e0b;">
                        $<%= financial.rentability.avgTicket.toFixed(0) %>
                    </div>
                    <div style="font-size: 14px; opacity: 0.7; margin-top: 8px;">Ticket Promedio</div>
                </div>

                <!-- Costo por Venta -->
                <div style="background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; padding: 20px; text-align: center;">
                    <div style="font-size: 48px; margin-bottom: 10px;">üíµ</div>
                    <div style="font-size: 32px; font-weight: bold; color: #a855f7;">
                        $<%= financial.rentability.costPerSale.toFixed(0) %>
                    </div>
                    <div style="font-size: 14px; opacity: 0.7; margin-top: 8px;">Costo por Venta</div>
                </div>

                <!-- Punto de Equilibrio -->
                <div style="background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; padding: 20px; text-align: center;">
                    <div style="font-size: 48px; margin-bottom: 10px;">‚öñÔ∏è</div>
                    <div style="font-size: 32px; font-weight: bold; color: #ec4899;">
                        <%= financial.rentability.breakEvenPoint %>
                    </div>
                    <div style="font-size: 14px; opacity: 0.7; margin-top: 8px;">Ventas para Equilibrio</div>
                </div>

                <!-- Ganancia Diaria Promedio -->
                <div style="background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; padding: 20px; text-align: center;">
                    <div style="font-size: 48px; margin-bottom: 10px;">üìÖ</div>
                    <div style="font-size: 32px; font-weight: bold; color: #10b981;">
                        $<%= financial.rentability.dailyAvgProfit.toFixed(0) %>
                    </div>
                    <div style="font-size: 14px; opacity: 0.7; margin-top: 8px;">Ganancia Diaria Promedio</div>
                </div>
            </div>
        </section>

        <!-- FLUJO DE CAJA -->
        <section class="conversion-metrics" style="margin-top: 30px;">
            <h2>üíº Flujo de Caja</h2>

            <div style="background: linear-gradient(135deg, rgba(255,255,255,0.08), rgba(255,255,255,0.02)); border: 1px solid rgba(255,255,255,0.1); border-radius: 16px; padding: 30px; margin-top: 20px;">
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 30px;">
                    <div>
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px;">
                            <span style="font-size: 32px;">üíµ</span>
                            <div>
                                <div style="font-size: 13px; opacity: 0.7;">Ingresos</div>
                                <div style="font-size: 24px; font-weight: bold; color: #10b981;">
                                    $<%= financial.cashFlow.ingresos.toLocaleString('es-AR') %>
                                </div>
                            </div>
                        </div>
                        <div style="background: rgba(16, 185, 129, 0.1); height: 8px; border-radius: 4px; overflow: hidden;">
                            <div style="background: #10b981; height: 100%; width: 100%; animation: fillBar 1s ease;"></div>
                        </div>
                    </div>

                    <div>
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px;">
                            <span style="font-size: 32px;">üí∏</span>
                            <div>
                                <div style="font-size: 13px; opacity: 0.7;">Egresos</div>
                                <div style="font-size: 24px; font-weight: bold; color: #ef4444;">
                                    $<%= financial.cashFlow.egresos.toLocaleString('es-AR') %>
                                </div>
                            </div>
                        </div>
                        <div style="background: rgba(239, 68, 68, 0.1); height: 8px; border-radius: 4px; overflow: hidden;">
                            <%
                            const egressPercentage = financial.cashFlow.ingresos > 0 ? (financial.cashFlow.egresos / financial.cashFlow.ingresos * 100) : 0;
                            %>
                            <div style="background: #ef4444; height: 100%; width: <%= egressPercentage %>%; animation: fillBar 1s ease;"></div>
                        </div>
                    </div>

                    <div>
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px;">
                            <span style="font-size: 32px;"><%= financial.cashFlow.flujoNeto >= 0 ? 'üìà' : 'üìâ' %></span>
                            <div>
                                <div style="font-size: 13px; opacity: 0.7;">Flujo Neto</div>
                                <div style="font-size: 24px; font-weight: bold; color: <%= financial.cashFlow.flujoNeto >= 0 ? '#3b82f6' : '#ef4444' %>;">
                                    <%= financial.cashFlow.flujoNeto >= 0 ? '+' : '' %>$<%= financial.cashFlow.flujoNeto.toLocaleString('es-AR') %>
                                </div>
                            </div>
                        </div>
                        <div style="background: rgba(59, 130, 246, 0.1); height: 8px; border-radius: 4px; overflow: hidden;">
                            <div style="background: <%= financial.cashFlow.flujoNeto >= 0 ? '#3b82f6' : '#ef4444' %>; height: 100%; width: <%= Math.abs(financial.cashFlow.flujoNeto / financial.cashFlow.ingresos * 100) %>%; animation: fillBar 1s ease;"></div>
                        </div>
                    </div>

                    <div>
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px;">
                            <span style="font-size: 32px;">üîÆ</span>
                            <div>
                                <div style="font-size: 13px; opacity: 0.7;">Proyecci√≥n Mensual</div>
                                <div style="font-size: 24px; font-weight: bold; color: #f59e0b;">
                                    $<%= financial.cashFlow.proyeccionMensual.toLocaleString('es-AR', {maximumFractionDigits: 0}) %>
                                </div>
                            </div>
                        </div>
                        <div style="background: rgba(245, 158, 11, 0.1); height: 8px; border-radius: 4px; overflow: hidden;">
                            <div style="background: #f59e0b; height: 100%; width: 75%; animation: fillBar 1s ease;"></div>
                        </div>
                    </div>
                </div>
            </div>

            <style>
                @keyframes fillBar {
                    from { width: 0%; }
                }
            </style>
        </section>

        <!-- PROYECCIONES FINANCIERAS -->
        <section class="conversion-metrics" style="margin-top: 30px;">
            <h2>üîÆ Proyecciones Financieras (Pr√≥ximos 6 Meses)</h2>

            <div style="background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 16px; padding: 30px; margin-top: 20px; overflow-x: auto;">
                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="border-bottom: 2px solid rgba(255,255,255,0.2);">
                            <th style="padding: 15px; text-align: left; font-size: 14px; opacity: 0.8;">Mes</th>
                            <th style="padding: 15px; text-align: right; font-size: 14px; opacity: 0.8;">Ingresos (ARS)</th>
                            <th style="padding: 15px; text-align: right; font-size: 14px; opacity: 0.8;">Ingresos (USD)</th>
                            <th style="padding: 15px; text-align: right; font-size: 14px; opacity: 0.8;">Gastos (ARS)</th>
                            <th style="padding: 15px; text-align: right; font-size: 14px; opacity: 0.8;">Ganancia (ARS)</th>
                            <th style="padding: 15px; text-align: right; font-size: 14px; opacity: 0.8;">Ganancia (USD)</th>
                            <th style="padding: 15px; text-align: right; font-size: 14px; opacity: 0.8;">ROI</th>
                            <th style="padding: 15px; text-align: right; font-size: 14px; opacity: 0.8;">Confianza</th>
                        </tr>
                    </thead>
                    <tbody>
                        <% projections.forEach((proj, index) => { %>
                        <tr style="border-bottom: 1px solid rgba(255,255,255,0.05); <%= index % 2 === 0 ? 'background: rgba(255,255,255,0.02);' : '' %>">
                            <td style="padding: 15px; font-weight: bold;">Mes <%= proj.month %></td>
                            <td style="padding: 15px; text-align: right; color: #10b981; font-weight: 600;">
                                $<%= proj.projectedRevenue.toLocaleString('es-AR', {maximumFractionDigits: 0}) %>
                            </td>
                            <td style="padding: 15px; text-align: right; color: #059669;">
                                USD $<%= proj.projectedRevenueUSD.toLocaleString('es-AR', {maximumFractionDigits: 0}) %>
                            </td>
                            <td style="padding: 15px; text-align: right; color: #ef4444;">
                                $<%= proj.projectedSpend.toLocaleString('es-AR', {maximumFractionDigits: 0}) %>
                            </td>
                            <td style="padding: 15px; text-align: right; color: <%= proj.projectedProfit >= 0 ? '#3b82f6' : '#ef4444' %>; font-weight: 600;">
                                <%= proj.projectedProfit >= 0 ? '+' : '' %>$<%= proj.projectedProfit.toLocaleString('es-AR', {maximumFractionDigits: 0}) %>
                            </td>
                            <td style="padding: 15px; text-align: right; color: <%= proj.projectedProfit >= 0 ? '#2563eb' : '#dc2626' %>;">
                                USD $<%= proj.projectedProfitUSD.toLocaleString('es-AR', {maximumFractionDigits: 0}) %>
                            </td>
                            <td style="padding: 15px; text-align: right; color: <%= proj.projectedROI >= 0 ? '#10b981' : '#ef4444' %>; font-weight: 600;">
                                <%= proj.projectedROI >= 0 ? '+' : '' %><%= proj.projectedROI.toFixed(1) %>%
                            </td>
                            <td style="padding: 15px; text-align: right;">
                                <div style="display: inline-block; background: <%= proj.confidence >= 80 ? 'rgba(16, 185, 129, 0.2)' : proj.confidence >= 60 ? 'rgba(245, 158, 11, 0.2)' : 'rgba(239, 68, 68, 0.2)' %>; color: <%= proj.confidence >= 80 ? '#10b981' : proj.confidence >= 60 ? '#f59e0b' : '#ef4444' %>; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 600;">
                                    <%= proj.confidence %>%
                                </div>
                            </td>
                        </tr>
                        <% }); %>
                    </tbody>
                </table>

                <div style="margin-top: 20px; padding: 15px; background: rgba(168, 85, 247, 0.1); border-left: 4px solid #a855f7; border-radius: 8px;">
                    <div style="font-weight: bold; margin-bottom: 8px; color: #c084fc;">üí° Nota sobre las proyecciones:</div>
                    <div style="font-size: 14px; opacity: 0.9;">
                        Las proyecciones asumen un crecimiento mensual del 10% basado en tendencias actuales. La confianza disminuye con el tiempo debido a la incertidumbre del mercado. Usa estas proyecciones como gu√≠a, no como garant√≠a.
                    </div>
                </div>
            </div>
        </section>

        <!-- AN√ÅLISIS POR CAMPA√ëA -->
        <section class="conversion-metrics" style="margin-top: 30px;">
            <h2>üìä Rentabilidad por Campa√±a</h2>

            <div style="display: grid; gap: 20px; margin-top: 20px;">
                <% Object.keys(financial.campaignFinancials).forEach(campaignName => {
                    const campaign = financial.campaignFinancials[campaignName];
                %>
                <div style="background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; padding: 25px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3 style="font-size: 20px; margin: 0;"><%= campaignName %></h3>
                        <div style="background: <%= campaign.profit >= 0 ? 'rgba(16, 185, 129, 0.2)' : 'rgba(239, 68, 68, 0.2)' %>; color: <%= campaign.profit >= 0 ? '#10b981' : '#ef4444' %>; padding: 8px 16px; border-radius: 20px; font-weight: bold;">
                            <%= campaign.profit >= 0 ? '+' : '' %>$<%= campaign.profit.toLocaleString('es-AR', {maximumFractionDigits: 0}) %>
                        </div>
                    </div>

                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;">
                        <div>
                            <div style="font-size: 12px; opacity: 0.7; margin-bottom: 5px;">Ingresos</div>
                            <div style="font-size: 18px; font-weight: bold; color: #10b981;">$<%= campaign.revenue.toLocaleString('es-AR') %></div>
                            <div style="font-size: 12px; opacity: 0.6;">USD $<%= campaign.revenueUSD.toLocaleString('es-AR', {maximumFractionDigits: 2}) %></div>
                        </div>

                        <div>
                            <div style="font-size: 12px; opacity: 0.7; margin-bottom: 5px;">Gastos</div>
                            <div style="font-size: 18px; font-weight: bold; color: #ef4444;">$<%= campaign.spend.toLocaleString('es-AR') %></div>
                            <div style="font-size: 12px; opacity: 0.6;">USD $<%= campaign.spendUSD.toLocaleString('es-AR', {maximumFractionDigits: 2}) %></div>
                        </div>

                        <div>
                            <div style="font-size: 12px; opacity: 0.7; margin-bottom: 5px;">Ganancia</div>
                            <div style="font-size: 18px; font-weight: bold; color: <%= campaign.profit >= 0 ? '#3b82f6' : '#ef4444' %>;">
                                <%= campaign.profit >= 0 ? '+' : '' %>$<%= campaign.profit.toLocaleString('es-AR') %>
                            </div>
                            <div style="font-size: 12px; opacity: 0.6;">USD $<%= campaign.profitUSD.toLocaleString('es-AR', {maximumFractionDigits: 2}) %></div>
                        </div>

                        <div>
                            <div style="font-size: 12px; opacity: 0.7; margin-bottom: 5px;">ROI</div>
                            <div style="font-size: 18px; font-weight: bold; color: <%= campaign.roi >= 0 ? '#10b981' : '#ef4444' %>;">
                                <%= campaign.roi >= 0 ? '+' : '' %><%= campaign.roi.toFixed(2) %>%
                            </div>
                        </div>

                        <div>
                            <div style="font-size: 12px; opacity: 0.7; margin-bottom: 5px;">ROAS</div>
                            <div style="font-size: 18px; font-weight: bold; color: #3b82f6;"><%= parseFloat(campaign.roas).toFixed(2) %>x</div>
                        </div>

                        <div>
                            <div style="font-size: 12px; opacity: 0.7; margin-bottom: 5px;">Margen</div>
                            <div style="font-size: 18px; font-weight: bold; color: #f59e0b;"><%= parseFloat(campaign.profitMargin).toFixed(2) %>%</div>
                        </div>
                    </div>
                </div>
                <% }); %>
            </div>
        </section>

        </div>
    </div>

    <style>
        .filter-btn {
            padding: 8px 16px;
            border-radius: 8px;
            border: 1px solid rgba(255,255,255,0.2);
            background: rgba(255,255,255,0.05);
            color: white;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .filter-btn:hover {
            background: rgba(255,255,255,0.1);
            border-color: rgba(255,255,255,0.3);
        }

        .filter-btn.active {
            background: #10b981;
            border-color: #10b981;
            color: white;
        }
    </style>

    <script>
        // Funci√≥n para toggle sidebar (heredada)
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const mainContent = document.getElementById('mainContent');
            const floatingBtn = document.getElementById('sidebarFloatingBtn');

            if (sidebar && mainContent && floatingBtn) {
                sidebar.classList.toggle('collapsed');
                mainContent.classList.toggle('expanded');
                floatingBtn.classList.toggle('visible');
            }
        }

        // Funciones de filtro de fecha
        function setDateFilter(type) {
            // Remover active de todos los botones
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));

            const today = new Date();
            let dateFrom, dateTo;

            switch(type) {
                case 'today':
                    dateFrom = dateTo = today.toISOString().split('T')[0];
                    document.getElementById('btn-today').classList.add('active');
                    break;
                case 'week':
                    const weekAgo = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
                    dateFrom = weekAgo.toISOString().split('T')[0];
                    dateTo = today.toISOString().split('T')[0];
                    document.getElementById('btn-week').classList.add('active');
                    break;
                case 'month':
                    const monthAgo = new Date(today.getFullYear(), today.getMonth(), 1);
                    dateFrom = monthAgo.toISOString().split('T')[0];
                    dateTo = today.toISOString().split('T')[0];
                    document.getElementById('btn-month').classList.add('active');
                    break;
                case 'all':
                    dateFrom = '';
                    dateTo = '';
                    document.getElementById('btn-all').classList.add('active');
                    break;
            }

            // Recargar con filtros
            const params = new URLSearchParams();
            if (dateFrom) params.set('dateFrom', dateFrom);
            if (dateTo) params.set('dateTo', dateTo);

            window.location.href = '/finanzas' + (params.toString() ? '?' + params.toString() : '');
        }

        function applyCustomDateFilter() {
            const dateFrom = document.getElementById('date-from').value;
            const dateTo = document.getElementById('date-to').value;

            if (!dateFrom || !dateTo) {
                alert('Por favor selecciona ambas fechas');
                return;
            }

            if (new Date(dateFrom) > new Date(dateTo)) {
                alert('La fecha "Desde" no puede ser mayor que la fecha "Hasta"');
                return;
            }

            // Remover active de todos los botones
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));

            // Recargar con filtros personalizados
            window.location.href = `/finanzas?dateFrom=${dateFrom}&dateTo=${dateTo}`;
        }

        // Inicializar fechas en los inputs
        window.addEventListener('DOMContentLoaded', () => {
            const urlParams = new URLSearchParams(window.location.search);
            const dateFrom = urlParams.get('dateFrom');
            const dateTo = urlParams.get('dateTo');

            // Establecer valores en los inputs si existen
            if (dateFrom) document.getElementById('date-from').value = dateFrom;
            if (dateTo) document.getElementById('date-to').value = dateTo;

            // Si hay filtros personalizados, no marcar ning√∫n bot√≥n como activo
            if (dateFrom && dateTo) {
                // Verificar qu√© filtro est√° activo
                const today = new Date();
                const todayStr = today.toISOString().split('T')[0];
                const monthStart = new Date(today.getFullYear(), today.getMonth(), 1).toISOString().split('T')[0];
                const weekAgo = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];

                // Remover active de todos
                document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));

                // Marcar el bot√≥n correcto seg√∫n los filtros
                if (dateFrom === todayStr && dateTo === todayStr) {
                    document.getElementById('btn-today').classList.add('active');
                } else if (dateFrom === weekAgo && dateTo === todayStr) {
                    document.getElementById('btn-week').classList.add('active');
                } else if (dateFrom === monthStart && dateTo === todayStr) {
                    document.getElementById('btn-month').classList.add('active');
                }
                // Si no coincide con ninguno, dejar sin marcar (filtro personalizado)
            }
        });

        // Actualizar cotizaci√≥n del d√≥lar cada 5 minutos (mantener filtros)
        setInterval(() => {
            // Mantener los par√°metros de URL al recargar
            window.location.href = window.location.href;
        }, 300000); // 5 minutos
    </script>
</body>
</html>
